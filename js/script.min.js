function ini_canvas_2d(e){(canvas_2d=new fabric.Canvas("canvas-2d")).backgroundColor="#eee",img.crossOrigin="anonymous",img.src=e,img.onload=function(){var e=img.width/img.height,a=window.innerWidth,t=window.innerWidth/e;t>window.innerHeight-200&&(a=(t=window.innerHeight-200)*e),$(".custom-box").width(a),$(".custom-box").height(t),canvas_2d.setOverlayImage("/images/creadit.png",function(){canvas_2d.overlayImage.width=canvas_2d.width/4,canvas_2d.overlayImage.height=canvas_2d.width/4,canvas_2d.overlayImage.top=canvas_2d.height-canvas_2d.width/4,canvas_2d.overlayImage.left=canvas_2d.width-canvas_2d.width/4,console.log("canvas_2d.overlayImage",canvas_2d.overlayImage),canvas_2d.renderAll()}),canvas_2d.setBackgroundImage(new fabric.Image(img,{originX:"left",originY:"top",left:0,top:0,width:a,height:t}),canvas_2d.renderAll.bind(canvas_2d))},canvas_2d.on("after:render",changeTexture),canvas_2d.on("object:modified",save),canvas_2d.on("object:added",save),canvas_2d.on("object:selected",onObjectSelected),save()}function onObjectSelected(e){(selected_object=e.target).set({borderColor:"#AC6CBD",cornerColor:"#AC6CBD",cornerSize:20,transparentCorners:!1,cornerStyle:"circle"}),selected_object.setControlsVisibility({tr:!0,br:!0,bl:!0,ml:!1,mt:!1,mr:!1,mb:!1,mtr:!0})}function insertImgWithUrl(e){fabric.Image.fromURL(e,function(e){var a=canvas_2d.width/e.width*.3;e.set({scaleX:a,scaleY:a,left:canvas_2d.width/3,top:canvas_2d.height/3}),canvas_2d.add(e)},{crossOrigin:"anonymous"})}function onWindowResize(){var e=img.width/img.height,a=window.innerWidth,t=window.innerWidth/e;t>window.innerHeight-200&&(a=(t=window.innerHeight-200)*e),$(".custom-box").width(a),$(".custom-box").height(t),canvas_2d.setBackgroundImage(new fabric.Image(img,{originX:"left",originY:"top",left:0,top:0,width:a,height:t}),canvas_2d.renderAll.bind(canvas_2d)),canvas_2d.setHeight(t),canvas_2d.setWidth(a),canvas_2d.renderAll.bind(canvas_2d)}function changeTexture(){loading_first_time||(loading_first_time=!0,setTimeout(save,500),onWindowResize(),window.addEventListener("resize",onWindowResize,!1))}function debounce(e,a,t,n){var i=this,c=arguments,o=t&&!timeoutInCase[n];clearTimeout(timeoutInCase[n]),timeoutInCase[n]=setTimeout(function(){timeoutInCase[n]=null,t||e.apply(i,c)},a),o&&e.apply(i,c)}function insert_shape(){var e,a=$("#colorSelector > .diy-color-box").css("backgroundColor"),t=canvas_2d.height/4;switch($("#select_shape").val()){case"cicle":e=new fabric.Circle({radius:t/2,fill:a,left:canvas_2d.width/3,top:canvas_2d.height/3});break;case"triangle":e=new fabric.Triangle({width:t,height:t,fill:a,left:canvas_2d.width/3,top:canvas_2d.height/3});break;case"line":e=new fabric.Rect({width:2*t,height:10,fill:a,left:canvas_2d.width/4,top:canvas_2d.height/2});break;case"square":e=new fabric.Rect({width:t,height:t,fill:a,left:canvas_2d.width/3,top:canvas_2d.height/3})}e.opacity=0==$("#opacity_shape").val()?.1:$("#opacity_shape").val(),canvas_2d.add(e)}function insert_text(){var e=$("#colorSelectorText > .diy-color-box").css("backgroundColor"),a=$("#input_text_insert").val(),t=$("#select_text_insert").val();(a=new fabric.Text(a,{fill:e,fontFamily:t,fontSize:40,left:canvas_2d.width/4,top:canvas_2d.height/2})).opacity=0==$("#opacity_text").val()?.1:$("#opacity_text").val(),canvas_2d.add(a)}function export_2d_json(){return JSON.stringify(canvas_2d.toJSON())}function clone_obj(){var e=canvas_2d.getActiveObject(),a=canvas_2d.getActiveGroup(),t=null;a?t=a:e&&(t=e);e=canvas_2d.getActiveObject(),a=canvas_2d.getActiveGroup();canvas_2d.discardActiveObject(),t.size?t.clone(function(e){canvas_2d.discardActiveGroup(),e.set({left:e.left+8,top:e.top+8,evented:!0}),e.forEachObject(function(e){e.set("active",!0),canvas_2d.add(e)}),canvas_2d.setActiveGroup(e).renderAll()}):t.clone(function(e){e.set("top",t.top+5).set("left",t.left+5).setCoords(),canvas_2d.add(e).setActiveObject(e).renderAll()})}function bring_front(){canvas_2d.bringToFront(canvas_2d.getActiveObject()),canvas_2d.deactivateAll().renderAll()}function send_back(){canvas_2d.sendToBack(canvas_2d.getActiveObject()),canvas_2d.deactivateAll().renderAll()}function save(){canRedo=!(redo=[]),state&&(undo.push(state),canUndo=!0),state=JSON.stringify(canvas_2d)}function replay(e,a){a.push(state),state=e.pop(),console.log(JSON.parse(state)),canvas_2d.clear(),canvas_2d.loadFromJSON(state,function(){canvas_2d.renderAll(),!0,e.length&&!0,canvas_2d.backgroundColor=canvas_2d.backgroundColor,onWindowResize()})}var container,canvas_2d,state,mouseX=0,mouseY=0,loading_first_time=!1,selected_object=null,undo=[],redo=[],img=new Image;window.deleteObject=function(){canvas_2d.getActiveObject()?canvas_2d.getActiveObject().remove():$("#alert-select-img").click()};var timeoutInCase={};document.getElementById("lnkDownload").addEventListener("click",function(){var e=canvas_2d.toDataURL({format:"jpeg",quality:.8}).replace(/^data:image\/[^;]+/,"data:application/octet-stream");window.open(e)},!1);var downloadCanvas=function(e,a){var t=canvas_2d.toDataURL({format:"png",multiplier:1});e.href=t,e.download=a},canUndo=!1,canRedo=!1;document.onkeydown=function(e){switch(window.event?window.event.keyCode:e.keyCode){case 67:clone_obj();break;case 46:canvas_2d.getActiveObject().remove()}};